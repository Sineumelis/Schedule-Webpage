<!-- Tengo que recordar que tengo que a√±adir que a la imagen creada se le ponga el cabecero con las instituciones que tiene el horario de aqu√≠ -->
<!-- Hacer que se guarden los datos escritos en la tabla en la nube respecto al √∫ltimo uso de esta online O A PARTIR DE UN CODIGO GENERADO QUE TE RESTAURE LA PAGINA, PERO PRECISO QUE SEA ONLINE PARA PODER ENTRAR EN LA PANTALLA; PODRIA HACERSE CON SOLAMENTE CHECKEAR LA IMAGEN QUE SEA LO SUBIDO ONLINE AL DARLE A GENERAR IMAGEN, tambien hacer que el codigo de dicha imagen sea el ultimo que quede ahi tras darle a generar imagen y que hasta que no se le de de nuevo no cambie, poner una confirmacion con algo para asegurarse de no darle por error, 2 confirmaciones diciendo que la accion borrar√° la anterior imagen -->
<!-- HECHO Hacer tambi√©n que pueda cambiar el color de fondo seg√∫n cliquees con el rat√≥n en la casilla -->
<!-- HECHO Hacer lo de cada d√≠a por la ma√±ana y por la tarde -->
<!-- Poder editar tama√±o de la celda arrastrando tambi√©n(?) -->
<!DOCTYPE html>
<html lang="it">
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Personalizza Tabella</title>

	<style>
		body {
    		font-family: Arial, sans-serif;
    		padding: 20px;
   	 		background-color: #f0f0f0;
  		}

  		select, button{
  			padding: 5px, 10px;
  			margin-right: 10px;
  			margin-left: 20px;
  		}

  		table{
  			border-collapse: collapse;
  			width: 100%;
  			max-width: 1600px;
  			background-color: #fff;
  		}

  		table, th, td {
  			border: 1px solid #828282;
  		}

  		td {
  			width: 120px;
  			height: 70px;
  			text-align: center;
  			vertical-align: middle;
  			cursor: text;
  		}

  		td:focus{
  			outline: 2px solid #007bff;
  		}
	</style>
</head>
<body>
	<h1>Ciao</h1>

	<label>
		Lines:
		<select id="rows_selected">
			<option value="1">1</option>
			<option value="2">2</option>
			<option value="3">3</option>
			<option value="4">4</option>
			<option value="5">5</option>
			<option value="6">6</option>
			<option value="7">7</option>
			<option value="8">8</option>
			<option value="9">9</option>
			<option value="10">10</option>
			<option value="11">11</option>
			<option value="12">12</option>
		</select>
	</label>

	<label>
		Columns:
		<select id="columns_selected">
			<option value="1">1</option>
			<option value="2">2</option>
			<option value="3">3</option>
			<option value="4">4</option>
			<option value="5">5</option>
			<option value="6">6</option>
			<option value="7">7</option>
			<option value="8">8</option>
			<option value="9">9</option>
			<option value="10">10</option>
			<option value="11">11</option>
			<option value="12">12</option>
		</select>
	</label>

	<button onclick="tableToImage()">Generate Image</button>

	<br><br>

	<label>Codice della Tabella:</label><br>
	<textarea id="tableCode" rows="5" cols="50" readonly placeholder="Table's code"></textarea>
	<button onclick="copyTableCode()">Copy Code</button>

	<br><br>

	<!-- <input type="text" id="loadCode" placeholder="Paste code here"> -->
	<label>Inserisci il Codice della Tabella:</label><br>
	<textarea id="loadCode" rows="5" cols="50" placeholder="Paste code here"></textarea>

	<button onclick="loadTableFromCode()">Load table</button>

	<br><br>

	<div id="editorControls">
	    <label>Lettera:
	        <select id="fontSelect" onchange="applyFont()">
	            <option value="Arial">Arial</option>
	            <option value="Courier New">Courier New</option>
	            <option value="Times New Roman">Times New Roman</option>
	            <option value="Verdana">Verdana</option>
	        </select>
	    </label>

	    <label>Misurare:
		    <input list="fontSizes" id="fontSizeInput" type="number" min="1" value="16" onchange="applyFontSize()">
		    <!--<datalist id="fontSizes">
		        <option value="8">
		        <option value="10">
		        <option value="12">
		        <option value="14">
		        <option value="18">
		        <option value="24">
		        <option value="32">
		    </datalist>-->
		</label>


	    <button onclick="execCmd('bold')"><b>B</b></button>
	    <button onclick="execCmd('italic')"><i>I</i></button>
	    <button onclick="execCmd('underline')"><u>U</u></button>
	    <input type="color" id="fontColor" onchange="applyColor()" value="#000000">
	    <button onclick="applyCellStyle()">Applicare</button>

	</div>

	<br>

	<button id="toggleColorModeBtn" onclick="toggleColorMode()">Attivare/Disabilitare colore</button>

	<br>

	<br>

	<!--<table id="planner"></table>-->

	<div id="plannerWrapper">
	  <div id="plannerHeader" style="text-align:center; margin-bottom:10px;">
	    <img src="LOGO1.png" style="height:50px; vertical-align:middle;">
	    <img src="LOGO2.png" style="height:50px; vertical-align:middle; margin-left:10px;">
	    <span style="font-weight:bold; font-size:20px; margin-left:15px;">
	      [Nombre de la Instituci√≥n]
	    </span>
	  </div>
	  <table id="planner"></table>
	</div>


	<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

	<!-- Firebase App -->
	<!--<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>-->
	<!-- Firebase Firestore -->
	<!--<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>-->


	<!--<script>
	// Configuraci√≥n de Firebase (cambia con tus datos)
	const firebaseConfig = {
	    apiKey: "TU_API_KEY",
	    authDomain: "TU_PROYECTO.firebaseapp.com",
	    projectId: "TU_PROYECTO",
	    storageBucket: "TU_PROYECTO.appspot.com",
	    messagingSenderId: "TU_SENDER_ID",
	    appId: "TU_APP_ID"
	};

	// Inicializar Firebase
	firebase.initializeApp(firebaseConfig);
	const db = firebase.firestore();
	</script>-->

	<!-- Firebase App (compat) -->
	<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
	<!-- Firebase Firestore (compat) -->
	<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

	<script>
		// Import the functions you need from the SDKs you need
		//import { initializeApp } from "firebase/app";
		//import { getAnalytics } from "firebase/analytics";
		// TODO: Add SDKs for Firebase products that you want to use
		// https://firebase.google.com/docs/web/setup#available-libraries

		// Your web app's Firebase configuration
		// For Firebase JS SDK v7.20.0 and later, measurementId is optional
		const firebaseConfig = {
		  apiKey: "AIzaSyBpaUCV3YYF3bQOV7icdsp8BNPu1k-QcxM",
		  authDomain: "schedule-it-69420.firebaseapp.com",
		  projectId: "schedule-it-69420",
		  storageBucket: "schedule-it-69420.firebasestorage.app",
		  messagingSenderId: "541795813911",
		  appId: "1:541795813911:web:7e4e28e28990bcbfc16a52",
		  measurementId: "G-K5BR2NTY3C"
		};

		firebase.initializeApp(firebaseConfig);
 	 	const db = firebase.firestore();

		// Initialize Firebase
		//const app = initializeApp(firebaseConfig);
		//const analytics = getAnalytics(app);
	</script>


<!-- Save Existing Data is needed -->
	<script>
		const table = document.getElementById('planner')
		const rows_select = document.getElementById('rows_selected');
		const columns_select = document.getElementById('columns_selected');

		const cellColors = ["#ADD8E6", "#B0C4DE", "#FFB6C1", "#FFA500", "#90EE90", "#FFFFFF"];

		let activeCell = null;

		let colorClickActive = false;

		function createTable(rows, columns){
			const oldData = [];

			for (let r = 0; r < table.rows.length; r++) {

    			oldData[r] = [];
    			
    			for (let c = 0; c < table.rows[r].cells.length; c++) {

        			oldData[r][c] = {
        				text: table.rows[r].cells[c].textContent,
                		color: table.rows[r].cells[c].style.backgroundColor || "#FFFFFF",
                		rowspan: table.rows[r].cells[c].rowSpan || 1
        			};

    			}
			}

			table.innerHTML = '';

			for (let r=0; r < rows; r++){

				const tr = table.insertRow();

				for (let c = 0; c < columns; c++){

					if (r > 0 && c == 0 && table.rows[r - 1]?.cells[0]?.rowSpan == 2) continue;

					const td = tr.insertCell();
					td.contentEditable = "true";

					td.addEventListener('focus', () => {
					    activeCell = td;
					});

					if (c == 0 && r % 2 == 0 && r + 1 < rows){
						td.rowSpan = 2;
					}

					if (oldData[r] && oldData[r][c] !== undefined){
						td.textContent = oldData[r][c].text;
						td.style.backgroundColor = oldData[r][c].color;
					}

					td.dataset.colorIndex = 0;
        			td.addEventListener('click', () => {
        				if (!colorClickActive) return;
            			let index = parseInt(td.dataset.colorIndex);
            			index = (index + 1) % cellColors.length;
            			td.style.backgroundColor = cellColors[index];
            			td.dataset.colorIndex = index;
        			});
				}
		}
	}

		rows_select.addEventListener('change', () => {
			createTable(parseInt(rows_select.value), table.rows[0]?.cells.length || 1);
		});
		columns_select.addEventListener('change', () => {
			createTable(table.rows.length || 1, parseInt(columns_select.value));
		});

		createTable(1,1);

		/*function tableToImage() {
		    const tableElement = document.getElementById('planner');

		    html2canvas(tableElement, { scale: 2, backgroundColor: null })
		    .then(canvas => {
		        const imgData = canvas.toDataURL('image/png');

		        // Guardar localmente
		        localStorage.setItem('plannerImage', imgData);

		        // Guardar en Firestore
		        db.collection("planner").doc("latest").set({
				    imageBase64: imgData,
				    timestamp: firebase.firestore.FieldValue.serverTimestamp()
				}).then(() => {
				    console.log("Imagen guardada en Firestore ‚úÖ");
				}).catch(err => {
				    console.error("Error guardando en Firestore:", err);
				});


		        // Guardar c√≥digo de la tabla como antes
		        const rows = table.rows.length;
		        const columns = table.rows[0]?.cells.length || 0;
		        const cells = [];
		        const occupied = Array.from({length: rows}, () => Array(columns).fill(false));

		        for (let r = 0; r < rows; r++) {
		            cells[r] = [];
		            let colIndex = 0;
		            const tr = table.rows[r];

		            for (let ci = 0; ci < tr.cells.length; ci++) {
		                while (occupied[r][colIndex]) colIndex++;
		                const td = tr.cells[ci];
		                cells[r][colIndex] = {
		                    text: td.textContent,
		                    color: td.style.backgroundColor || "#FFFFFF",
		                    rowspan: td.rowSpan || 1
		                };
		                for (let i = 0; i < td.rowSpan; i++) {
		                    if (r + i < rows) occupied[r + i][colIndex] = true;
		                }
		                colIndex++;
		            }
		        }
		        document.getElementById('tableCode').value = JSON.stringify({ rows, columns, cells });
		    });
		}*/

		const docRef = db.collection("planner").doc("latest");
		const tableElement = document.getElementById('planner');
		const tableCodeTextarea = document.getElementById('tableCode');
		const loadCodeTextarea = document.getElementById('loadCode');
		const rows_select = document.getElementById('rows_selected');
		const columns_select = document.getElementById('columns_selected');

		// Generar un c√≥digo √∫nico para cada imagen (timestamp + random)
		function generateImageCode() {
		    return Date.now().toString(36) + "-" + Math.random().toString(36).slice(2,8);
		}

		function serializeTable() {
		    const rows = tableElement.rows.length;
		    const columns = tableElement.rows[0]?.cells.length || 0;
		    const cells = [];
		    const occupied = Array.from({length: rows}, () => Array(columns).fill(false));

		    for (let r = 0; r < rows; r++) {
		        cells[r] = [];
		        let colIndex = 0;
		        const tr = tableElement.rows[r];

		        for (let ci = 0; ci < tr.cells.length; ci++) {
		            while (occupied[r][colIndex]) colIndex++;
		            const td = tr.cells[ci];
		            const style = window.getComputedStyle(td);

		            cells[r][colIndex] = {
		                text: td.innerHTML, // guarda contenido con formato (negrita, color, etc.)
		                color: style.backgroundColor || "#FFFFFF",
		                rowspan: td.rowSpan || 1,
		                fontFamily: style.fontFamily,
		                fontSize: style.fontSize,
		                fontColor: style.color,
		                fontWeight: style.fontWeight,
		                fontStyle: style.fontStyle,
		                textDecoration: style.textDecoration
		            };

		            for (let i = 0; i < td.rowSpan; i++) {
		                if (r + i < rows) occupied[r + i][colIndex] = true;
		            }
		            colIndex++;
		        }
		    }

		    return { rows, columns, cells };
		}


		function showNotification(message, duration = 2000) {
		    const notif = document.createElement('div');
		    notif.textContent = message;
		    notif.style.position = 'fixed';
		    notif.style.top = '20px';
		    notif.style.right = '20px';
		    notif.style.padding = '10px 20px';
		    notif.style.backgroundColor = '#333';
		    notif.style.color = 'white';
		    notif.style.borderRadius = '8px';
		    notif.style.boxShadow = '0 2px 6px rgba(0,0,0,0.3)';
		    notif.style.zIndex = 9999;
		    notif.style.opacity = 0;
		    notif.style.transition = 'opacity 0.3s';
		    document.body.appendChild(notif);
		    requestAnimationFrame(() => { notif.style.opacity = 1; });
		    setTimeout(() => {
		        notif.style.opacity = 0;
		        setTimeout(() => { notif.remove(); }, 300);
		    }, duration);
		}

		async function tableToImage() {
		    try {
		        const wrapperElement = document.getElementById('plannerWrapper');
		        const canvas = await html2canvas(wrapperElement, { scale: 2, backgroundColor: null });
		        const imgData = canvas.toDataURL('image/png');

		        // Chequear si ya existe una imagen
		        const snapshot = await docRef.get();
		        if (snapshot.exists) {
		            const ok1 = confirm("Ya existe una imagen guardada. Esta acci√≥n sobrescribir√° la anterior. ¬øContinuar?");
		            if (!ok1) {
		                showNotification("Generaci√≥n cancelada");
		                return;
		            }
		            const ok2 = confirm("Confirmaci√≥n final: ¬øSeguro que quieres sobrescribir la imagen anterior?");
		            if (!ok2) {
		                showNotification("Generaci√≥n cancelada");
		                return;
		            }
		        } else {
		            const ok = confirm("Guardar nueva imagen en Firestore?");
		            if (!ok) {
		                showNotification("Generaci√≥n cancelada");
		                return;
		            }
		        }

		        const newCode = generateImageCode();
		        const tableJson = serializeTable(); // incluye estilos ahora

		        await docRef.set({
		            imageBase64: imgData,
		            code: newCode,
		            tableJson: tableJson,
		            timestamp: firebase.firestore.FieldValue.serverTimestamp()
		        });

		        localStorage.setItem('plannerImage', imgData);
		        tableCodeTextarea.value = newCode;

		        showNotification("Imagen generada y guardada correctamente ‚úÖ", 2500);
		    } catch (err) {
		        console.error("Error generando/guardando imagen:", err);
		        alert("Error generando o guardando la imagen. Mira la consola.");
		    }
		}


		// üî• Escucha autom√°tica al cargar la p√°gina para mostrar la √∫ltima imagen (si quieres mostrarla en la edici√≥n tambi√©n)
		window.addEventListener('load', () => {
		    docRef.onSnapshot(doc => {
		        if (doc.exists) {
		            const data = doc.data();
		            if (data.imageBase64) {
		                // Si quieres mostrar la imagen generada en el editor, puedes crear un <img> donde quieras
		                console.log("Imagen actualizada desde Firestore");
		            }
		        }
		    });
		});

		function loadTableFromCode() {
		    const code = document.getElementById('loadCode').value;
		    if (!code) return;

		    try {
		        const obj = JSON.parse(code);
		        const { rows, columns, cells } = obj;

		        table.innerHTML = '';
		        const occupied = Array.from({length: rows}, () => Array(columns).fill(false));

		        for (let r = 0; r < rows; r++) {
		            const tr = table.insertRow();
		            let colIndex = 0;

		            while (colIndex < columns) {
		                if (occupied[r][colIndex]) {
		                    colIndex++;
		                    continue;
		                }

		                const cellData = cells[r][colIndex] || { text: '', color: '#FFFFFF', rowspan: 1 };
		                const td = tr.insertCell();
		                td.contentEditable = "true";
		                td.innerHTML = cellData.text || "";
		                td.style.backgroundColor = cellData.color || "#FFFFFF";
		                if (cellData.rowspan && cellData.rowspan > 1) td.rowSpan = cellData.rowspan;

		                // restaurar estilos si existen
		                if (cellData.fontFamily) td.style.fontFamily = cellData.fontFamily;
		                if (cellData.fontSize) td.style.fontSize = cellData.fontSize;
		                if (cellData.fontColor) td.style.color = cellData.fontColor;
		                if (cellData.fontWeight) td.style.fontWeight = cellData.fontWeight;
		                if (cellData.fontStyle) td.style.fontStyle = cellData.fontStyle;
		                if (cellData.textDecoration) td.style.textDecoration = cellData.textDecoration;

		                for (let i = 0; i < td.rowSpan; i++) {
		                    if (r + i < rows) occupied[r + i][colIndex] = true;
		                }

		                td.dataset.colorIndex = 0;
		                td.addEventListener('click', () => {
		                    if (!colorClickActive) return;
		                    let index = parseInt(td.dataset.colorIndex);
		                    index = (index + 1) % cellColors.length;
		                    td.style.backgroundColor = cellColors[index];
		                    td.dataset.colorIndex = index;
		                });

		                colIndex++;
		            }
		        }

		        rows_select.value = rows;
		        columns_select.value = columns;

		    } catch (e) {
		        alert("Codice non valido.");
		    }
		}


		function copyTableCode() {
    		const codeTextarea = document.getElementById('tableCode');
    		const code = codeTextarea.value;

    		if (!code) return;

    		navigator.clipboard.writeText(code);
		}

		function execCmd(command) {
		    if (!activeCell) return;

		    activeCell.focus();
		    document.execCommand(command, false, null);
		}

		function applyFont() {
		    const font = document.getElementById('fontSelect').value;
		    document.execCommand('fontName', false, font);
		}

		function applyFontSize() {
		    const size = document.getElementById('fontSizeInput').value;

		    document.execCommand('fontSize', false, 3); 
		    const selection = window.getSelection();
		    if (!selection.rangeCount) return;


		    const span = document.createElement('span');
		    span.style.fontSize = size + 'px';
		    span.innerHTML = selection.toString();

		    const range = selection.getRangeAt(0);
		    range.deleteContents();
		    range.insertNode(span);
		}


		function applyColor() {
		    const color = document.getElementById('fontColor').value;
		    document.execCommand('foreColor', false, color);
		}

		function applyCellStyle() {
		    if (!activeCell) return;

		    const font = document.getElementById('fontSelect').value;
		    const size = document.getElementById('fontSizeInput').value + 'px';
		    const color = document.getElementById('fontColor').value;

		    // Revisamos si hay selecci√≥n de texto dentro de la celda
		    const selection = window.getSelection();
		    if (!selection.rangeCount) {

		        activeCell.style.fontFamily = font;
		        activeCell.style.fontSize = size;
		        activeCell.style.color = color;
		        return;
		    }

		    const range = selection.getRangeAt(0);

		    if (!activeCell.contains(range.commonAncestorContainer)) {
		        alert("Selecciona texto dentro de la celda activa.");
		        return;
		    }

		    const span = document.createElement('span');
		    span.style.fontFamily = font;
		    span.style.fontSize = size;
		    span.style.color = color;
		    span.innerHTML = selection.toString();

		    range.deleteContents();
		    range.insertNode(span);

		    selection.removeAllRanges();
		}

		function toggleColorMode() {
		    colorClickActive = !colorClickActive;
		    const btn = document.getElementById('toggleColorModeBtn');
		    btn.textContent = colorClickActive ? "Disabilitare colore" : "Attivare colore";
		}

	</script>
</body>
</html>