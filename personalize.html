<!-- Tengo que recordar que tengo que a√±adir que a la imagen creada se le ponga el cabecero con las instituciones que tiene el horario de aqu√≠ -->
<!-- Hacer que se guarden los datos escritos en la tabla en la nube respecto al √∫ltimo uso de esta online O A PARTIR DE UN CODIGO GENERADO QUE TE RESTAURE LA PAGINA, PERO PRECISO QUE SEA ONLINE PARA PODER ENTRAR EN LA PANTALLA; PODRIA HACERSE CON SOLAMENTE CHECKEAR LA IMAGEN QUE SEA LO SUBIDO ONLINE AL DARLE A GENERAR IMAGEN, tambien hacer que el codigo de dicha imagen sea el ultimo que quede ahi tras darle a generar imagen y que hasta que no se le de de nuevo no cambie, poner una confirmacion con algo para asegurarse de no darle por error, 2 confirmaciones diciendo que la accion borrar√° la anterior imagen -->
<!-- HECHO Hacer tambi√©n que pueda cambiar el color de fondo seg√∫n cliquees con el rat√≥n en la casilla -->
<!-- HECHO Hacer lo de cada d√≠a por la ma√±ana y por la tarde -->
<!-- Poder editar tama√±o de la celda arrastrando tambi√©n(?) -->
<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Personalizza Tabella</title>

  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      background-color: #f0f0f0;
    }

    select, button {
      padding: 5px 10px;
      margin-right: 10px;
      margin-left: 20px;
    }

    table {
      border-collapse: collapse;
      width: 100%;
      max-width: 1600px;
      background-color: #fff;
    }

    table, th, td {
      border: 1px solid #828282;
    }

    td {
      width: 120px;
      height: 70px;
      text-align: center;
      vertical-align: middle;
      cursor: text;
    }

    td:focus {
      outline: 2px solid #007bff;
    }
  </style>
</head>
<body>
  <h1>Ciao</h1>

  <label>
    Lines:
    <select id="rows_selected">
      <option value="1">1</option>
      <option value="2">2</option>
      <option value="3">3</option>
      <option value="4">4</option>
      <option value="5">5</option>
      <option value="6">6</option>
      <option value="7">7</option>
      <option value="8">8</option>
      <option value="9">9</option>
      <option value="10">10</option>
      <option value="11">11</option>
      <option value="12">12</option>
    </select>
  </label>

  <label>
    Columns:
    <select id="columns_selected">
      <option value="1">1</option>
      <option value="2">2</option>
      <option value="3">3</option>
      <option value="4">4</option>
      <option value="5">5</option>
      <option value="6">6</option>
      <option value="7">7</option>
      <option value="8">8</option>
      <option value="9">9</option>
      <option value="10">10</option>
      <option value="11">11</option>
      <option value="12">12</option>
    </select>
  </label>

  <button onclick="tableToImage()">Generate Image</button>

  <br><br>

  <label>Codice della Tabella:</label><br>
  <textarea id="tableCode" rows="5" cols="50" readonly placeholder="Table's code"></textarea>
  <button onclick="copyTableCode()">Copy Code</button>

  <br><br>

  <label>Inserisci il Codice della Tabella:</label><br>
  <textarea id="loadCode" rows="5" cols="50" placeholder="Paste code here"></textarea>
  <button onclick="loadTableFromCode()">Load table</button>

  <br><br>

  <div id="editorControls">
    <label>Lettera:
      <select id="fontSelect" onchange="applyFont()">
        <option value="Arial">Arial</option>
        <option value="Courier New">Courier New</option>
        <option value="Times New Roman">Times New Roman</option>
        <option value="Verdana">Verdana</option>
      </select>
    </label>

    <label>Misurare:
      <input list="fontSizes" id="fontSizeInput" type="number" min="1" value="16" onchange="applyFontSize()">
    </label>

    <button onclick="execCmd('bold')"><b>B</b></button>
    <button onclick="execCmd('italic')"><i>I</i></button>
    <button onclick="execCmd('underline')"><u>U</u></button>
    <input type="color" id="fontColor" onchange="applyColor()" value="#000000">
    <button onclick="applyCellStyle()">Applicare</button>
  </div>

  <br>
  <button id="toggleColorModeBtn" onclick="toggleColorMode()">Attivare/Disabilitare colore</button>

  <br><br>
  <button onclick="loadFromFirestore()">Cargar desde Firestore</button>

  <table id="planner"></table>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js";
    import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBpaUCV3YYF3bQOV7icdsp8BNPu1k-QcxM",
      authDomain: "schedule-it-69420.firebaseapp.com",
      projectId: "schedule-it-69420",
      storageBucket: "schedule-it-69420.appspot.com",
      messagingSenderId: "541795813911",
      appId: "1:541795813911:web:7e4e28e28990bcbfc16a52",
      measurementId: "G-K5BR2NTY3C"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const table = document.getElementById('planner');
    const rows_select = document.getElementById('rows_selected');
    const columns_select = document.getElementById('columns_selected');

    const cellColors = ["#ADD8E6", "#B0C4DE", "#FFB6C1", "#FFA500", "#90EE90", "#FFFFFF"];
    let activeCell = null;
    let colorClickActive = false;

    function createTable(rows, columns) {
      const oldData = [];
      for (let r = 0; r < table.rows.length; r++) {
        oldData[r] = [];
        for (let c = 0; c < table.rows[r].cells.length; c++) {
          oldData[r][c] = {
            text: table.rows[r].cells[c].innerHTML,
            color: table.rows[r].cells[c].style.backgroundColor || "#FFFFFF",
            rowspan: table.rows[r].cells[c].rowSpan || 1
          };
        }
      }

      table.innerHTML = '';
      for (let r = 0; r < rows; r++) {
        const tr = table.insertRow();
        for (let c = 0; c < columns; c++) {
          if (r > 0 && c == 0 && table.rows[r - 1]?.cells[0]?.rowSpan == 2) continue;

          const td = tr.insertCell();
          td.contentEditable = "true";

          td.addEventListener('focus', () => activeCell = td);

          if (c == 0 && r % 2 == 0 && r + 1 < rows) td.rowSpan = 2;

          if (oldData[r] && oldData[r][c] !== undefined) {
            td.innerHTML = oldData[r][c].text;
            td.style.backgroundColor = oldData[r][c].color;
          }

          td.dataset.colorIndex = 0;
          td.addEventListener('click', () => {
            if (!colorClickActive) return;
            let index = parseInt(td.dataset.colorIndex);
            index = (index + 1) % cellColors.length;
            td.style.backgroundColor = cellColors[index];
            td.dataset.colorIndex = index;
          });
        }
      }
    }

    rows_select.addEventListener('change', () => createTable(parseInt(rows_select.value), table.rows[0]?.cells.length || 1));
    columns_select.addEventListener('change', () => createTable(table.rows.length || 1, parseInt(columns_select.value)));

    createTable(1, 1);

    window.tableToImage = async function() {
      if (!table) return alert("No hay tabla para guardar.");

      const rows = table.rows.length;
      const columns = table.rows[0]?.cells.length || 0;

      const cellList = [];
      const occupied = Array.from({ length: rows }, () => Array(columns).fill(false));

      // üìã Guardar datos de la tabla
      for (let r = 0; r < rows; r++) {
        let colIndex = 0;
        const tr = table.rows[r];

        for (let ci = 0; ci < tr.cells.length; ci++) {
          while (occupied[r][colIndex]) colIndex++;

          const td = tr.cells[ci];
          cellList.push({
            row: r,
            col: colIndex,
            text: td.innerHTML,
            color: td.style.backgroundColor || "#FFFFFF",
            rowspan: td.rowSpan || 1
          });

          for (let i = 0; i < td.rowSpan; i++) {
            if (r + i < rows) occupied[r + i][colIndex] = true;
          }
          colIndex++;
        }
      }

      try {
        // üíæ Guardar tabla
        await setDoc(doc(db, "planner", "latestTable"), {
          rows,
          columns,
          cells: cellList,
          updated: new Date().toISOString()
        });

        // üé® Crear un clon invisible de la tabla sin m√°rgenes ni padding
        const clone = table.cloneNode(true);
        clone.style.margin = "0";
        clone.style.padding = "0";
        clone.style.borderCollapse = "collapse";
        clone.style.backgroundColor = "#FFFFFF";
        document.body.appendChild(clone);

        // üì∏ Capturar solo el clon
        const canvas = await html2canvas(clone, {
          scale: 3, // alta resoluci√≥n
          backgroundColor: "#FFFFFF",
          useCORS: true,
          removeContainer: true
        });

        document.body.removeChild(clone);

        // üñº Convertir a Base64
        const imgData = canvas.toDataURL("image/png");

        // üî• Subir imagen a Firestore
        await setDoc(doc(db, "planner", "latestImage"), {
          image: imgData,
          updated: new Date().toISOString()
        });

        alert("‚úÖ Tabla e imagen guardadas correctamente en Firestore.");
      } catch (e) {
        console.error("Error al guardar en Firestore:", e);
        alert("‚ùå Error al guardar en Firestore. Mira la consola.");
      }
    };

    // Cargar tabla desde Firestore
    window.loadFromFirestore = async function() {
      try {
        const docRef = doc(db, "planner", "latestTable");
        const snapshot = await getDoc(docRef);
        if (!snapshot.exists()) return alert("‚ö†Ô∏è No hay datos guardados todav√≠a.");

        const data = snapshot.data();
        const { rows, columns, cells } = data;
        table.innerHTML = '';
        const occupied = Array.from({ length: rows }, () => Array(columns).fill(false));

        for (let r = 0; r < rows; r++) {
          const tr = table.insertRow();
          for (let c = 0; c < columns; c++) {
            if (occupied[r][c]) continue;
            const cellData = cells.find(cell => cell.row === r && cell.col === c);
            const td = tr.insertCell();
            td.contentEditable = "true";
            if (cellData) {
              td.innerHTML = cellData.text;
              td.style.backgroundColor = cellData.color;
              if (cellData.rowspan && cellData.rowspan > 1) td.rowSpan = cellData.rowspan;
            } else {
              td.innerHTML = "";
              td.style.backgroundColor = "#FFFFFF";
            }

            for (let i = 0; i < td.rowSpan; i++) {
              if (r + i < rows) occupied[r + i][c] = true;
            }

            td.dataset.colorIndex = 0;
            td.addEventListener('click', () => {
              if (!colorClickActive) return;
              let index = parseInt(td.dataset.colorIndex);
              index = (index + 1) % cellColors.length;
              td.style.backgroundColor = cellColors[index];
              td.dataset.colorIndex = index;
            });
          }
        }

        rows_select.value = rows;
        columns_select.value = columns;
        alert("‚úÖ Tabla cargada desde Firestore.");
      } catch (e) {
        console.error("Error al cargar Firestore:", e);
        alert("‚ùå Error al cargar Firestore. Mira la consola.");
      }
    };

        // Copiar c√≥digo de tabla
    function copyTableCode() {
      const textarea = document.getElementById('tableCode');
      textarea.select();
      document.execCommand('copy');
      alert('üìã Copiato negli appunti!');
    }

    // Aplicar comandos de formato directo
    function execCmd(command) {
      document.execCommand(command, false, null);
    }

    // Aplica tipo de letra a la celda activa
    function applyFont() {
      if (!activeCell) return alert("‚ö†Ô∏è Seleziona una cella prima!");
      const font = document.getElementById('fontSelect').value;
      activeCell.style.fontFamily = font;
    }

    // Aplica tama√±o de fuente
    function applyFontSize() {
      if (!activeCell) return alert("‚ö†Ô∏è Seleziona una cella prima!");
      const size = document.getElementById('fontSizeInput').value;
      activeCell.style.fontSize = size + 'px';
    }

    // Aplica color de texto
    function applyColor() {
      if (!activeCell) return alert("‚ö†Ô∏è Seleziona una cella prima!");
      const color = document.getElementById('fontColor').value;
      activeCell.style.color = color;
    }

    // Aplica todos los estilos juntos (bot√≥n ‚ÄúApplicare‚Äù)
    function applyCellStyle() {
      if (!activeCell) return alert("‚ö†Ô∏è Seleziona una cella prima!");
      const font = document.getElementById('fontSelect').value;
      const size = document.getElementById('fontSizeInput').value;
      const color = document.getElementById('fontColor').value;
      activeCell.style.fontFamily = font;
      activeCell.style.fontSize = size + 'px';
      activeCell.style.color = color;
    }

    // Cargar tabla desde c√≥digo (opcional)
    function loadTableFromCode() {
      const code = document.getElementById('loadCode').value.trim();
      if (!code) return alert("‚ö†Ô∏è Nessun codice incollato!");

      try {
        const data = JSON.parse(code);
        const { rows, columns, cells } = data;
        table.innerHTML = '';
        const occupied = Array.from({ length: rows }, () => Array(columns).fill(false));

        for (let r = 0; r < rows; r++) {
          const tr = table.insertRow();
          for (let c = 0; c < columns; c++) {
            if (occupied[r][c]) continue;
            const cellData = cells.find(cell => cell.row === r && cell.col === c);
            const td = tr.insertCell();
            td.contentEditable = "true";
            if (cellData) {
              td.innerHTML = cellData.text;
              td.style.backgroundColor = cellData.color;
              td.style.fontFamily = cellData.fontFamily || 'Arial';
              td.style.fontSize = cellData.fontSize || '16px';
              td.style.color = cellData.textColor || '#000000';
              if (cellData.rowspan && cellData.rowspan > 1) td.rowSpan = cellData.rowspan;
            } else {
              td.innerHTML = "";
              td.style.backgroundColor = "#FFFFFF";
            }

            for (let i = 0; i < td.rowSpan; i++) {
              if (r + i < rows) occupied[r + i][c] = true;
            }

            td.addEventListener('focus', () => activeCell = td);
            td.dataset.colorIndex = 0;
            td.addEventListener('click', () => {
              if (!colorClickActive) return;
              let index = parseInt(td.dataset.colorIndex);
              index = (index + 1) % cellColors.length;
              td.style.backgroundColor = cellColors[index];
              td.dataset.colorIndex = index;
            });
          }
        }

        rows_select.value = rows;
        columns_select.value = columns;
        alert("‚úÖ Tabella caricata dal codice!");
      } catch (e) {
        console.error("Errore nel codice:", e);
        alert("‚ùå Codice non valido!");
      }
    }


  </script>

</body>
</html>
